<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDT SAMU Metropolitana</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
</head>
<body>
  <div id="particles-js"></div>

  <div class="login" id="login">
    <h2>Iniciar Sesión</h2>
    <input type="text" id="usuario" placeholder="Nombre completo">
    <button onclick="iniciarSesion()">Entrar</button>
  </div>

  <div class="container" id="sistema" style="display:none;">
    <div id="perfil">
      <h2>Mi Perfil</h2>
      <img id="imagenPerfil" src="https://via.placeholder.com/100" alt="Perfil">
      <input type="color" id="colorPerfil">
      <button onclick="cambiarImagen()">Cambiar Imagen</button>
      <h4 id="nombrePerfil"></h4>
    </div>

    <div class="pacientes">
      <h2>Registrar Paciente</h2>
      <input type="text" id="nombrePaciente" placeholder="Nombre Paciente">
      <input type="text" id="apellidoPaciente" placeholder="Apellido Paciente">
      <input type="text" id="razon" placeholder="Razón">
      <button onclick="registrarPaciente()">Registrar</button>
    </div>

    <div class="registros">
      <h2>Registros de Pacientes</h2>
      <ul id="listaPacientes"></ul>
    </div>

    <div class="adminPanel" id="adminPanel" style="display:none">
      <h2>Panel de Administrador</h2>
      <ul id="listaUsuarios"></ul>
    </div>
  </div>

  <input type="file" id="fileInput" style="display:none">

  <script>
    const admins = ["admin", "jefe", "director"];
    let usuario = localStorage.getItem("usuario") || "";

    document.addEventListener("DOMContentLoaded", () => {
      tsParticles.load("particles-js", {
        particles: {
          number: { value: 60 },
          size: { value: 4 },
          color: { value: ["#00faff", "#ff00ff", "#00ff00"] },
          move: { enable: true, speed: 2 },
          line_linked: { enable: true, distance: 100, color: "#fff" }
        }
      });

      if (usuario) mostrarSistema();
    });

    function iniciarSesion() {
      usuario = document.getElementById("usuario").value.trim().toLowerCase();
      if (!usuario) return alert("Ingresa tu nombre completo");
      localStorage.setItem("usuario", usuario);
      mostrarSistema();
    }

    function mostrarSistema() {
      document.getElementById("login").style.display = "none";
      document.getElementById("sistema").style.display = "block";
      document.getElementById("nombrePerfil").innerText = usuario;
      cargarPerfil();
      mostrarPacientes();
      if (admins.includes(usuario)) document.getElementById("adminPanel").style.display = "block";
      mostrarUsuarios();
    }

    function registrarPaciente() {
      const nombre = document.getElementById("nombrePaciente").value;
      const apellido = document.getElementById("apellidoPaciente").value;
      const razon = document.getElementById("razon").value;
      if (!nombre || !apellido || !razon) return;
      const pacientes = JSON.parse(localStorage.getItem("pacientes") || "[]");
      pacientes.push({ nombre, apellido, razon, registradoPor: usuario });
      localStorage.setItem("pacientes", JSON.stringify(pacientes));
      mostrarPacientes();
    }

    function mostrarPacientes() {
      const lista = document.getElementById("listaPacientes");
      lista.innerHTML = "";
      const pacientes = JSON.parse(localStorage.getItem("pacientes") || "[]");
      pacientes.forEach((p, i) => {
        lista.innerHTML += `
          <li>
            ${p.nombre} ${p.apellido} - ${p.razon} (Por: ${p.registradoPor})
            ${admins.includes(usuario) ? `<button onclick="eliminarPaciente(${i})">Eliminar</button>` : ""}
          </li>
        `;
      });
    }

    function eliminarPaciente(i) {
      const pacientes = JSON.parse(localStorage.getItem("pacientes") || "[]");
      pacientes.splice(i, 1);
      localStorage.setItem("pacientes", JSON.stringify(pacientes));
      mostrarPacientes();
    }

    function cambiarImagen() {
      document.getElementById("fileInput").click();
    }

    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        document.getElementById("imagenPerfil").src = reader.result;
        localStorage.setItem("imgPerfil_" + usuario, reader.result);
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("colorPerfil").addEventListener("input", (e) => {
      document.getElementById("perfil").style.background = e.target.value;
      localStorage.setItem("colorPerfil_" + usuario, e.target.value);
    });

    function cargarPerfil() {
      const color = localStorage.getItem("colorPerfil_" + usuario);
      const img = localStorage.getItem("imgPerfil_" + usuario);
      if (color) document.getElementById("perfil").style.background = color;
      if (img) document.getElementById("imagenPerfil").src = img;
    }

    function mostrarUsuarios() {
      if (!admins.includes(usuario)) return;
      const lista = document.getElementById("listaUsuarios");
      const pacientes = JSON.parse(localStorage.getItem("pacientes") || "[]");
      const usuariosUnicos = [...new Set(pacientes.map(p => p.registradoPor))];
      lista.innerHTML = usuariosUnicos.map(u => `<li>${u}</li>`).join("");
    }
  </script>
</body>
</html>
