<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MDT - Sistema SAMU</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="particles-js"></div>

  <header class="top-bar">
    <div class="perfil">
      <img id="imagenPerfil" src="default.png" alt="Perfil" />
      <div>
        <h3 id="usuarioNombre">No conectado</h3>
        <button onclick="cambiarImagen()">Cambiar Imagen</button>
      </div>
    </div>
    <button onclick="cerrarSesion()" class="cerrar-sesion">Cerrar Sesión</button>
  </header>

  <main class="container">
    <section id="login">
      <h2>Iniciar Sesión SAMU</h2>
      <input type="text" id="nombreUsuario" placeholder="Nombre completo" />
      <input type="text" id="placaUsuario" placeholder="Placa" />
      <button onclick="iniciarSesion()">Ingresar</button>
    </section>

    <section id="formulario" style="display:none;">
      <h2>Registrar Paciente</h2>
      <input type="text" id="pacienteNombre" placeholder="Nombre del paciente" />
      <input type="text" id="pacienteApellido" placeholder="Apellido del paciente" />
      <input type="text" id="razon" placeholder="Razón" />
      <button onclick="guardarPaciente()">Guardar Paciente</button>
    </section>

    <section id="panel">
      <h2>Registros</h2>
      <ul id="listaRegistros"></ul>
    </section>

    <section id="usuarios">
      <h2>Usuarios</h2>
      <ul id="listaUsuarios"></ul>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
  <script>
    tsParticles.load("particles-js", {
      particles: {
        number: { value: 60 },
        size: { value: 4 },
        color: { value: "#00faff" },
        move: { enable: true, speed: 2 },
        line_linked: { enable: true, distance: 100, color: "#fff" }
      }
    });

    const admins = ["danilo cuevas", "jefe samu", "admin general"];
    let usuario = JSON.parse(localStorage.getItem("usuarioSAMU")) || null;

    if (usuario) cargarSesion();

    function iniciarSesion() {
      const nombre = document.getElementById("nombreUsuario").value.toLowerCase();
      const placa = document.getElementById("placaUsuario").value;
      if (!nombre || !placa) return;
      usuario = { nombre, placa };
      localStorage.setItem("usuarioSAMU", JSON.stringify(usuario));
      cargarSesion();
    }

    function cargarSesion() {
      document.getElementById("login").style.display = "none";
      document.getElementById("formulario").style.display = "block";
      document.getElementById("usuarioNombre").innerText = usuario.nombre;
      mostrarRegistros();
      mostrarUsuarios();
    }

    function cerrarSesion() {
      localStorage.removeItem("usuarioSAMU");
      location.reload();
    }

    function cambiarImagen() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = () => {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = () => {
          document.getElementById("imagenPerfil").src = reader.result;
          localStorage.setItem("imgPerfil", reader.result);
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    const imgGuardada = localStorage.getItem("imgPerfil");
    if (imgGuardada) document.getElementById("imagenPerfil").src = imgGuardada;

    function guardarPaciente() {
      const nombre = document.getElementById("pacienteNombre").value;
      const apellido = document.getElementById("pacienteApellido").value;
      const razon = document.getElementById("razon").value;
      if (!nombre || !apellido || !razon) return;
      const registro = { nombre, apellido, razon, creadoPor: usuario.nombre, fecha: new Date().toLocaleString() };
      let registros = JSON.parse(localStorage.getItem("registrosSAMU")) || [];
      registros.push(registro);
      localStorage.setItem("registrosSAMU", JSON.stringify(registros));
      mostrarRegistros();
      mostrarUsuarios();
    }

    function mostrarRegistros() {
      const lista = document.getElementById("listaRegistros");
      const registros = JSON.parse(localStorage.getItem("registrosSAMU")) || [];
      lista.innerHTML = "";
      registros.forEach((r, i) => {
        lista.innerHTML += `
          <li>
            <strong>${r.nombre} ${r.apellido}</strong> - ${r.razon} <br/><em>Por: ${r.creadoPor}</em>
            ${esAdmin() ? `<br/><button onclick="eliminarRegistro(${i})">Eliminar</button>` : ""}
          </li>
        `;
      });
    }

    function mostrarUsuarios() {
      const registros = JSON.parse(localStorage.getItem("registrosSAMU")) || [];
      const lista = document.getElementById("listaUsuarios");
      const nombres = [...new Set(registros.map(r => r.creadoPor))];
      lista.innerHTML = nombres.map(n => `<li>${n}</li>`).join("");
    }

    function eliminarRegistro(i) {
      let registros = JSON.parse(localStorage.getItem("registrosSAMU")) || [];
      registros.splice(i, 1);
      localStorage.setItem("registrosSAMU", JSON.stringify(registros));
      mostrarRegistros();
      mostrarUsuarios();
    }

    function esAdmin() {
      return usuario && admins.includes(usuario.nombre);
    }
  </script>
</body>
</html>
