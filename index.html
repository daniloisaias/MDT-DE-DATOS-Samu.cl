<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MDT - Sistema SAMU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
</head>
<body>
  <div id="particles-js"></div>

  <!-- Sección Login -->
  <section id="loginSection">
    <h2>Iniciar Sesión SAMU</h2>
    <input type="text" id="loginUser" placeholder="Nombre de Usuario" />
    <input type="text" id="loginPlaca" placeholder="Placa" />
    <button onclick="iniciarSesion()">Iniciar Sesión</button>
    <p id="loginError" style="color:#f33;display:none;">Usuario o placa incorrectos.</p>
  </section>

  <!-- Perfil y personalización -->
  <header id="perfil" style="display:none;">
    <div class="info">
      <img src="https://i.pravatar.cc/50" alt="Imagen Perfil" id="imgPerfil" />
      <div>
        <div class="nombre" id="nombrePerfil"></div>
        <small id="placaPerfil"></small>
      </div>
    </div>
    <button onclick="cerrarSesion()">Cerrar Sesión</button>
  </header>

  <!-- Personalización -->
  <section id="personalizacion" style="display:none; padding: 10px 20px; background:#222; max-width:900px; margin:auto;">
    <label for="colorPicker">Color de Perfil:</label>
    <input type="color" id="colorPicker" value="#00faff" />
    <button onclick="cambiarColorPerfil()">Cambiar Color</button>
    <label for="imgURL">URL Imagen Perfil:</label>
    <input type="text" id="imgURL" placeholder="URL Imagen" />
    <button onclick="cambiarImagenPerfil()">Cambiar Imagen</button>
  </section>

  <div class="container" style="display:none;">
    <!-- Formulario paciente -->
    <form id="formPaciente">
      <h3>Agregar Paciente</h3>
      <label>Nombre Paciente</label>
      <input type="text" id="pacienteNombre" required />
      <label>Apellido Paciente</label>
      <input type="text" id="pacienteApellido" required />
      <label>Razón / Motivo</label>
      <textarea id="pacienteRazon" rows="3" required></textarea>
      <label>Fecha y Hora</label>
      <input type="datetime-local" id="fechaHora" required />
      <button type="submit">Guardar Paciente</button>
    </form>

    <!-- Listas -->
    <section id="usuariosLista">
      <h3>Usuarios SAMU</h3>
      <ul id="listaUsuarios"></ul>
    </section>

    <section id="pacientesLista">
      <h3>Pacientes Registrados</h3>
      <ul id="listaPacientes"></ul>
    </section>
  </div>

<script>
  // Partículas
  tsParticles.load("particles-js", {
    particles: {
      number: { value: 60 },
      size: { value: 4 },
      color: { value: "#00faff" },
      move: { enable: true, speed: 2 },
      line_linked: { enable: true, distance: 100, color: "#fff" }
    }
  });

  // Usuarios "admins" con permisos especiales
  const admins = [
    { user: "danilo", placa: "1234" },
    { user: "jefe samu", placa: "0000" }
  ];

  // Variables globales
  let usuarioActual = null; // {user, placa, color, img}
  let usuarios = JSON.parse(localStorage.getItem("usuariosSAMU")) || [];
  let pacientes = JSON.parse(localStorage.getItem("pacientesSAMU")) || [];

  // Elementos DOM
  const loginSection = document.getElementById("loginSection");
  const perfilSection = document.getElementById("perfil");
  const container = document.querySelector(".container");
  const personalizacion = document.getElementById("personalizacion");

  const nombrePerfil = document.getElementById("nombrePerfil");
  const placaPerfil = document.getElementById("placaPerfil");
  const imgPerfil = document.getElementById("imgPerfil");
  const colorPicker = document.getElementById("colorPicker");
  const imgURL = document.getElementById("imgURL");

  // Login
  function iniciarSesion() {
    const user = document.getElementById("loginUser").value.trim().toLowerCase();
    const placa = document.getElementById("loginPlaca").value.trim();

    if (!user || !placa) {
      mostrarErrorLogin(true);
      return;
    }

    // Buscar usuario guardado
    let usuarioGuardado = usuarios.find(u => u.user === user && u.placa === placa);

    // Si no existe, crear nuevo
    if (!usuarioGuardado) {
      usuarioGuardado = { user, placa, color: "#00faff", img: "https://i.pravatar.cc/50" };
      usuarios.push(usuarioGuardado);
      guardarUsuarios();
    }

    usuarioActual = usuarioGuardado;

    mostrarErrorLogin(false);
    actualizarVistaSesion(true);
    cargarDatosUsuario();
  }

  function mostrarErrorLogin(mostrar) {
    document.getElementById("loginError").style.display = mostrar ? "block" : "none";
  }

  function guardarUsuarios() {
    localStorage.setItem("usuariosSAMU", JSON.stringify(usuarios));
  }

  function guardarPacientes() {
    localStorage.setItem("pacientesSAMU", JSON.stringify(pacientes));
  }

  function actualizarVistaSesion(logueado) {
    loginSection.style.display = logueado ? "none" : "block";
    perfilSection.style.display = logueado ? "flex" : "none";
    container.style.display = logueado ? "block" : "none";
    personalizacion.style.display = logueado ? "block" : "none";
  }

  function cargarDatosUsuario() {
    nombrePerfil.textContent = usuarioActual.user;
    placaPerfil.textContent = "Placa: " + usuarioActual.placa;
    imgPerfil.src = usuarioActual.img;
    colorPicker.value = usuarioActual.color;
    document.body.style.backgroundColor = usuarioActual.color;

    mostrarUsuarios();
    mostrarPacientes();
  }

  // Cerrar sesión
  function cerrarSesion() {
    usuarioActual = null;
    actualizarVistaSesion(false);
  }

  // Cambiar color perfil
  function cambiarColorPerfil() {
    const color = colorPicker.value;
    usuarioActual.color = color;
    document.body.style.backgroundColor = color;
    guardarCambiosUsuario();
  }

  // Cambiar imagen perfil
  function cambiarImagenPerfil() {
    const url = imgURL.value.trim();
    if (url) {
      usuarioActual.img = url;
      imgPerfil.src = url;
      guardarCambiosUsuario();
    }
  }

  // Guardar cambios de usuario en usuarios array
  function guardarCambiosUsuario() {
    const index = usuarios.findIndex(u => u.user === usuarioActual.user && u.placa === usuarioActual.placa);
    if (index > -1) {
      usuarios[index] = usuarioActual;
      guardarUsuarios();
    }
  }

  // Mostrar lista usuarios
  function mostrarUsuarios() {
    const lista = document.getElementById("listaUsuarios");
    lista.innerHTML = "";

    usuarios.forEach(u => {
      const li = document.createElement("li");
      li.className = "usuarioItem";
      li.textContent = u.user + " - Placa: " + u.placa;

      // Botones admin si usuario es admin
      if (esAdmin()) {
        const btnEditar = document.createElement("button");
        btnEditar.className = "btn-editar";
        btnEditar.textContent = "Editar";

        btnEditar.onclick = () => editarUsuario(u.user, u.placa);
        li.appendChild(btnEditar);

        const btnBorrar = document.createElement("button");
        btnBorrar.className = "btn-borrar";
        btnBorrar.textContent = "Borrar";

        btnBorrar.onclick = () => {
          if (confirm(`¿Eliminar usuario ${u.user}?`)) {
            eliminarUsuario(u.user, u.placa);
          }
        };
        li.appendChild(btnBorrar);
      }

      lista.appendChild(li);
    });
  }

  // Editar usuario (admin)
  function editarUsuario(user, placa) {
    const nuevoUser = prompt("Nuevo nombre de usuario:", user);
    if (!nuevoUser) return;
    const nuevaPlaca = prompt("Nueva placa:", placa);
    if (!nuevaPlaca) return;

    const index = usuarios.findIndex(u => u.user === user && u.placa === placa);
    if (index > -1) {
      usuarios[index].user = nuevoUser.toLowerCase();
      usuarios[index].placa = nuevaPlaca;
      guardarUsuarios();
      mostrarUsuarios();
      alert("Usuario editado.");
    }
  }

  // Eliminar usuario (admin)
  function eliminarUsuario(user, placa) {
    usuarios = usuarios.filter(u => !(u.user === user && u.placa === placa));
    guardarUsuarios();

    // También borrar pacientes relacionados a ese usuario (opcional)
    pacientes = pacientes.filter(p => !(p.creadoPor === user));
    guardarPacientes();

    mostrarUsuarios();
    mostrarPacientes();
  }

  // Mostrar pacientes
  function mostrarPacientes() {
    const lista = document.getElementById("listaPacientes");
    lista.innerHTML = "";

    pacientes.forEach((p, i) => {
      const li = document.createElement("li");
      li.className = "pacienteItem";
      li.innerHTML = `<strong>${p.nombre} ${p.apellido}</strong> - Razón: ${p.razon} - Fecha: ${p.fecha} <br/>
                      Creado por: ${p.creadoPor}`;

      if (esAdmin() || p.creadoPor === usuarioActual.user) {
        const btnEditar = document.createElement("button");
        btnEditar.className = "btn-editar";
        btnEditar.textContent = "Editar";

        btnEditar.onclick = () => editarPaciente(i);
        li.appendChild(btnEditar);

        const btnBorrar = document.createElement("button");
        btnBorrar.className = "btn-borrar";
        btnBorrar.textContent = "Borrar";

        btnBorrar.onclick = () => {
          if (confirm("¿Eliminar paciente?")) {
            eliminarPaciente(i);
          }
        };
        li.appendChild(btnBorrar);
      }

      lista.appendChild(li);
    });
  }

  // Agregar paciente
  document.getElementById("formPaciente").addEventListener("submit", function(e) {
    e.preventDefault();

    if (!usuarioActual) {
      alert("Inicia sesión primero.");
      return;
    }

    const nombre = document.getElementById("pacienteNombre").value.trim();
    const apellido = document.getElementById("pacienteApellido").value.trim();
    const razon = document.getElementById("pacienteRazon").value.trim();
    const fecha = document.getElementById("fechaHora").value;

    if (!nombre || !apellido || !razon || !fecha) {
      alert("Completa todos los campos.");
      return;
    }

    pacientes.push({
      nombre,
      apellido,
      razon,
      fecha,
      creadoPor: usuarioActual.user
    });
    guardarPacientes();
    mostrarPacientes();

    this.reset();
  });

  // Editar paciente
  function editarPaciente(index) {
    const p = pacientes[index];
    const nombre = prompt("Editar nombre:", p.nombre);
    if (!nombre) return;
    const apellido = prompt("Editar apellido:", p.apellido);
    if (!apellido) return;
    const razon = prompt("Editar razón:", p.razon);
    if (!razon) return;
    const fecha = prompt("Editar fecha (YYYY-MM-DDTHH:MM):", p.fecha);
    if (!fecha) return;

    pacientes[index] = {
      nombre,
      apellido,
      razon,
      fecha,
      creadoPor: p.creadoPor
    };
    guardarPacientes();
    mostrarPacientes();
  }

  // Eliminar paciente
  function eliminarPaciente(index) {
    pacientes.splice(index, 1);
    guardarPacientes();
    mostrarPacientes();
  }

  // Comprobar si usuario es admin
  function esAdmin() {
    if (!usuarioActual) return false;
    return admins.some(a => a.user === usuarioActual.user && a.placa === usuarioActual.placa);
  }

  // Al cargar la página, si ya hay usuario en localStorage, iniciar sesión automática
  window.onload = function() {
    // Podrías implementar guardar sesión, por ejemplo:
    // Aquí solo mostramos login por ahora
  };
</script>

</body>
</html>
